========================================================================================================================
Measurement文件路径及其所属Bucket列表
========================================================================================================================

 1. database/simlingo_v2_2025_01_10/data/simlingo/validation_1_scenario/routes_validation/random_weather_seed_2_balanced_150/Town13_Rep0_1693_route0_01_11_14_49_48/measurements/0185.json.gz
    Buckets (9): acceleration_-5, brake, junction, lateral_control_0.1, leading_object_traffic.stop, speed_limit_13.88888888888889, stop_sign, stop_sign_close, target_speed_5

 2. database/simlingo_v2_2025_01_10/data/simlingo/training_3_scenarios/routes_training/random_weather_seed_3_balanced_100/Town12_Rep0_56_route0_01_11_06_00_12/measurements/0777.json.gz
    Buckets (5): acceleration_-1, junction, lateral_control_5, speed_limit_33.333333333333336, target_speed_20

 3. database/simlingo_v2_2025_01_10/data/simlingo/validation_3_scenarios/routes_validation/random_weather_seed_4_balanced_100/Town13_Rep0_1347_route0_01_12_02_21_53/measurements/0183.json.gz
    Buckets (7): acceleration_5, junction, lateral_control_5, speed_limit_13.88888888888889, start_from_stop, start_from_stop_old, target_speed_5

 4. database/simlingo_v2_2025_01_10/data/simlingo/validation_3_scenarios/routes_validation/random_weather_seed_4_balanced_100/Town13_Rep0_1182_route0_01_11_21_13_13/measurements/0213.json.gz
    Buckets (5): acceleration_20, changed_route, lateral_control_1000000, speed_limit_22.22222222222222, target_speed_20

 5. database/simlingo_v2_2025_01_10/data/simlingo/validation_3_scenarios/routes_validation/random_weather_seed_4_balanced_100/Town13_Rep0_804_route0_01_11_09_50_51/measurements/0387.json.gz
    Buckets (4): acceleration_1, lateral_control_1, speed_limit_33.333333333333336, target_speed_25

 6. database/simlingo_v2_2025_01_10/data/simlingo/training_1_scenario/routes_training/random_weather_seed_1_balanced_150/Town12_Rep0_1523_route0_01_11_02_55_13/measurements/0154.json.gz
    Buckets (6): acceleration_5, junction, lateral_control_2, leading_object_vehicle, speed_limit_33.333333333333336, target_speed_15

 7. database/simlingo_v2_2025_01_10/data/simlingo/training_1_scenario/routes_training/random_weather_seed_1_balanced_150/Town12_Rep0_1562_route0_01_11_00_35_00/measurements/0072.json.gz
    Buckets (5): acceleration_1, lateral_control_5, leading_object_vehicle, speed_limit_33.333333333333336, target_speed_20

 8. database/simlingo_v2_2025_01_10/data/simlingo/validation_1_scenario/routes_validation/random_weather_seed_2_balanced_150/Town13_Rep0_4414_route0_01_10_18_00_06/measurements/0118.json.gz
    Buckets (8): acceleration_20, green_light, junction, lateral_control_1, speed_limit_13.88888888888889, start_from_stop, start_from_stop_old, target_speed_15

 9. database/simlingo_v2_2025_01_10/data/simlingo/training_3_scenarios/routes_training/random_weather_seed_3_balanced_100/Town12_Rep0_428_route0_01_11_11_17_54/measurements/0703.json.gz
    Buckets (9): acceleration_1, brake, changed_route, lateral_control_0.1, leading_object_vehicle, speed_limit_33.333333333333336, target_speed_0.5, vehicle, vehicle_front

10. database/simlingo_v2_2025_01_10/data/simlingo/training_parking_lane/Town12_short/random_weather_seed_10_balanced_150/Town12_Rep0_10_route0_01_11_11_45_25/measurements/0318.json.gz
    Buckets (9): acceleration_1, brake, junction, lateral_control_0.1, leading_object_vehicle, speed_limit_13.88888888888889, target_speed_0.5, vehicle, vehicle_side

11. database/simlingo_v2_2025_01_10/data/simlingo/validation_1_scenario/routes_validation/random_weather_seed_2_balanced_150/Town13_Rep0_476_route0_01_12_03_13_23/measurements/1341.json.gz
    Buckets (7): acceleration_1, brake, junction, lateral_control_0.1, leading_object_vehicle, speed_limit_33.333333333333336, target_speed_0.5

12. database/simlingo_v2_2025_01_10/data/simlingo/validation_3_scenarios/routes_validation/random_weather_seed_4_balanced_100/Town13_Rep0_1055_route0_01_11_07_03_35/measurements/1869.json.gz
    Buckets (8): acceleration_1, changed_route, lateral_control_0.1, leading_object_traffic.stop, speed_limit_27.77777777777778, start_from_stop, stop_sign, target_speed_5

13. database/simlingo_v2_2025_01_10/data/simlingo/training_3_scenarios/routes_training/random_weather_seed_3_balanced_100/Town12_Rep0_1361_route0_01_12_03_25_12/measurements/0086.json.gz
    Buckets (9): acceleration_1, brake, junction, lateral_control_0.1, leading_object_traffic.traffic_light, light, red_light, speed_limit_13.88888888888889, target_speed_0.5

14. database/simlingo_v2_2025_01_10/data/simlingo/training_3_scenarios/routes_training/random_weather_seed_3_balanced_100/Town12_Rep0_1211_route0_01_11_20_45_14/measurements/0109.json.gz
    Buckets (9): acceleration_1, brake, junction, lateral_control_0.1, leading_object_walker, speed_limit_13.88888888888889, stop_sign_close, target_speed_0.5, walker_hazard

15. database/simlingo_v2_2025_01_10/data/simlingo/training_1_scenario/routes_training/random_weather_seed_1_balanced_150/Town12_Rep0_2394_route0_01_11_00_49_52/measurements/0368.json.gz
    Buckets (8): acceleration_1, brake, changed_route, lateral_control_0.1, leading_object_vehicle, speed_limit_33.333333333333336, target_speed_0.5, vehicle

16. database/simlingo_v2_2025_01_10/data/simlingo/training_parking_lane/Town12_short/random_weather_seed_10_balanced_150/Town12_Rep0_28_route0_01_11_22_43_15/measurements/0193.json.gz
    Buckets (7): acceleration_5, green_light, junction, lateral_control_1000000, parkinglane, speed_limit_13.88888888888889, target_speed_10

17. database/simlingo_v2_2025_01_10/data/simlingo/validation_3_scenarios/routes_validation/random_weather_seed_4_balanced_100/Town13_Rep0_356_route0_01_10_18_34_16/measurements/0195.json.gz
    Buckets (5): acceleration_1, lateral_control_1, leading_object_vehicle, speed_limit_27.77777777777778, target_speed_20

18. database/simlingo_v2_2025_01_10/data/simlingo/validation_1_scenario/routes_validation/random_weather_seed_2_balanced_150/Town13_Rep0_4862_route0_01_11_18_35_29/measurements/0063.json.gz
    Buckets (4): acceleration_1, lateral_control_0.1, speed_limit_13.88888888888889, target_speed_10

19. database/simlingo_v2_2025_01_10/data/simlingo/validation_1_scenario/routes_validation/random_weather_seed_2_balanced_150/Town13_Rep0_995_route0_01_11_15_23_17/measurements/0035.json.gz
    Buckets (4): acceleration_1, lateral_control_1, speed_limit_13.88888888888889, target_speed_15

20. database/simlingo_v2_2025_01_10/data/simlingo/validation_parking_lane/Town13_short/random_weather_seed_11_balanced_150/Town13_Rep0_75_route0_01_11_11_02_54/measurements/0311.json.gz
    Buckets (6): acceleration_1, brake, lateral_control_0.1, leading_object_vehicle, speed_limit_22.22222222222222, target_speed_0.5


========================================================================================================================
总共有 2,918,516 个唯一的measurement文件
平均每个文件属于 6.41 个bucket

========================================================================================================================
Bucket统计信息：所有Key及其对应的Value数量
========================================================================================================================

  1. acceleration_-1                                    -> 234,383 个文件
  2. acceleration_-20                                   -> 90 个文件
  3. acceleration_-5                                    -> 126,637 个文件
  4. acceleration_1                                     -> 2,077,641 个文件
  5. acceleration_20                                    -> 177,362 个文件
  6. acceleration_5                                     -> 296,868 个文件
  7. brake                                              -> 1,489,654 个文件
  8. changed_route                                      -> 177,020 个文件
  9. green_light                                        -> 85,554 个文件
 10. junction                                           -> 796,819 个文件
 11. lateral_control_0.1                                -> 2,272,980 个文件
 12. lateral_control_1                                  -> 361,691 个文件
 13. lateral_control_1000000                            -> 57,295 个文件
 14. lateral_control_2                                  -> 110,416 个文件
 15. lateral_control_5                                  -> 110,599 个文件
 16. leading_object_static.prop.trafficwarning          -> 35,947 个文件
 17. leading_object_traffic.stop                        -> 83,948 个文件
 18. leading_object_traffic.traffic_light               -> 184,425 个文件
 19. leading_object_vehicle                             -> 1,918,608 个文件
 20. leading_object_walker                              -> 26,000 个文件
 21. light                                              -> 275,125 个文件
 22. parkinglane                                        -> 13,529 个文件
 23. red_light                                          -> 270,576 个文件
 24. speed_limit_13.88888888888889                      -> 1,321,430 个文件
 25. speed_limit_22.22222222222222                      -> 492,472 个文件
 26. speed_limit_27.77777777777778                      -> 483,114 个文件
 27. speed_limit_33.333333333333336                     -> 615,965 个文件
 28. start_from_stop                                    -> 96,793 个文件
 29. start_from_stop_old                                -> 153,706 个文件
 30. stop_sign                                          -> 171,678 个文件
 31. stop_sign_close                                    -> 194,974 个文件
 32. target_speed_0.5                                   -> 1,383,225 个文件
 33. target_speed_10                                    -> 636,527 个文件
 34. target_speed_15                                    -> 264,243 个文件
 35. target_speed_20                                    -> 209,944 个文件
 36. target_speed_25                                    -> 137,403 个文件
 37. target_speed_5                                     -> 281,639 个文件
 38. vehicle                                            -> 629,921 个文件
 39. vehicle_dissapears                                 -> 5,535 个文件
 40. vehicle_front                                      -> 41,130 个文件
 41. vehicle_side                                       -> 382,304 个文件
 42. walker_hazard                                      -> 26,354 个文件

========================================================================================================================
总共有 42 个不同的bucket
所有bucket中的文件路径总数: 18,711,524
========================================================================================================================


========================================================================================================================
配置文件中的Bucket名称与实际Bucket的映射关系
========================================================================================================================

根据 dataset_base.py 中的代码，配置文件中的bucket名称与实际bucket的映射关系如下：

1. acceleration_negative_5
   -> 对应实际bucket: acceleration_-5
   (注释: smaller than -5 m/s^2 -> -20 AND -5，但代码中只使用了 -5)

2. acceleration_negative_1
   -> 对应实际bucket: acceleration_-1
   (注释: between -1 and -5 m/s^2 -> -1)

3. acceleration_positive_1
   -> 对应实际bucket: acceleration_5
   (注释: between 1 and 5 m/s^2 -> 5)

4. acceleration_positive_5
   -> 对应实际bucket: acceleration_20
   (注释: larger than 5 m/s^2 -> 20)

5. lateral_control_1_2
   -> 对应实际bucket: lateral_control_1 + lateral_control_2
   (注释: wp diff in y dir larger than 0.1 and smaller than 1 -> 1)
   (实际: 包含 lateral_control_1 和 lateral_control_2 两个bucket的合并)

6. lateral_control_higher_5
   -> 对应实际bucket: lateral_control_5 + lateral_control_1000000
   (注释: wp diff in y dir larger than 5 -> 5 AND 1000000)
   (实际: 包含 lateral_control_5 和 lateral_control_1000000 两个bucket的合并)

其他配置名称（如 start_from_stop, vehicle_front, vehicle_side 等）直接对应同名的实际bucket。

========================================================================================================================


========================================================================================================================
carla_bucket_v12.yaml 配置评价与分析
========================================================================================================================

【配置用途】
这个配置文件用于控制自动驾驶模型训练时的数据采样策略。它通过 WeightedRandomSampler 
对不同的驾驶场景/行为进行加权采样，目的是：
1. 平衡不同场景的训练数据（避免常见场景占主导）
2. 提高模型在关键/困难场景上的表现
3. 确保稀有但重要的场景（如行人、停车等）得到充分训练

【权重分布分析】

总权重: 1.000 (已归一化) ✓

权重分配概览：
- 横向控制相关: 0.24 (lateral_control_1_2: 0.12, lateral_control_higher_5: 0.12)
- 前导物体相关: 0.28 (leading_object_vehicle: 0.09, traffic.stop: 0.07, traffic_light: 0.07, walker: 0.05)
- 加速度相关: 0.12 (4个bucket各0.03)
- 车辆交互: 0.12 (vehicle_side: 0.08, vehicle_front: 0.04)
- 其他场景: 0.238 (start_from_stop, changed_route, parkinglane, all)

【合理性评价】

✓ 优点：
1. 重点关注横向控制（0.24权重）- 这是自动驾驶的关键技能
2. 平衡了前导物体类型（车辆、交通灯、停止标志、行人）
3. 覆盖了多种加速度场景（负加速、正加速）
4. 包含了稀有但重要的场景（parkinglane: 0.008, walker: 0.05）

⚠ 潜在问题：

1. 【数据不平衡导致的采样效率问题】
   - leading_object_walker (权重0.05, 数据量26,000) 是瓶颈
   - 每个epoch最多采样 520,000 个样本（受限于最小有效采样数）
   - leading_object_vehicle (权重0.09, 数据量1,918,608) 会被大幅下采样
   - 这意味着大量车辆跟随数据被浪费

2. 【权重与数据量不匹配】
   - start_from_stop: 权重0.07但只有96,793个样本 → 需要大量重复采样
   - leading_object_traffic.stop: 权重0.07但只有83,948个样本 → 需要大量重复采样
   - leading_object_vehicle: 权重0.09但有1,918,608个样本 → 会被严重下采样

3. 【缺少的场景】
   - 没有包含 junction (796,819个文件) - 这是重要的交叉路口场景
   - 没有包含 brake (1,489,654个文件) - 这是重要的紧急制动场景
   - 没有包含 stop_sign (171,678个文件) - 这是重要的停止标志场景

4. 【横向控制分布】
   - lateral_control_0.1 有2,272,980个文件（最大），但配置中没有使用
   - 这可能意味着大部分数据（正常横向控制）被忽略了

【建议】

1. 考虑增加 junction、brake、stop_sign 等关键场景
2. 对于数据量很大的bucket（如 leading_object_vehicle），可以考虑：
   - 降低权重，或
   - 使用数据子集
3. 对于数据量很小的bucket（如 leading_object_walker），考虑：
   - 数据增强，或
   - 接受更高的重复采样率
4. 考虑使用 lateral_control_0.1 来代表正常驾驶场景
5. 监控训练过程中的实际采样分布，确保符合预期

【总结】
配置整体思路合理，重点关注了关键驾驶场景。但存在数据不平衡问题，可能导致：
- 某些场景过度重复采样（可能过拟合）
- 某些场景数据利用不充分（可能欠拟合）
建议根据实际训练效果调整权重，并考虑增加更多关键场景。

========================================================================================================================


========================================================================================================================
Benchmark场景特征与训练数据采样策略的对应关系分析
========================================================================================================================

【分析目的】
评估训练配置 (carla_bucket_v12.yaml) 中的bucket分布是否基于Bench2Drive benchmark的场景特征进行设计。

【Benchmark场景统计】
Bench2Drive benchmark包含 220 个场景，涉及 44 种不同的场景类型，分布如下：

1. Junction相关场景: 60个 (27.3%)
   - SignalizedJunction (有信号灯路口)
   - NonSignalizedJunction (无信号灯路口)
   - T_Junction (T型路口)
   - BlockedIntersection (阻塞路口)

2. Vehicle交互场景: 60个 (27.3%)
   - VehicleTurningRoute (车辆转弯)
   - HighwayCutIn (高速切入)
   - StaticCutIn (静态切入)
   - MergerIntoSlowTraffic (并入慢速车流)
   - EnterActorFlow (进入车流)
   - OppositeVehicleRunningRedLight (对向车辆闯红灯)

3. Obstacle相关场景: 35个 (15.9%)
   - ParkedObstacle (停车障碍)
   - ConstructionObstacle (施工障碍)
   - HazardAtSideLane (侧方车道危险)

4. Control相关场景: 20个 (9.1%)
   - ControlLoss (失控)
   - HardBreakRoute (急刹)
   - InvadingTurn (侵入转弯)

5. Parking相关场景: 15个 (6.8%)
   - ParkingCutIn (停车切入)
   - ParkingExit (停车驶出)

6. Pedestrian相关场景: 15个 (6.8%)
   - PedestrianCrossing (行人横穿)
   - ParkingCrossingPedestrian (停车区行人)

7. Emergency/Accident场景: 15个 (6.8%)
   - Accident (事故)
   - YieldToEmergencyVehicle (让行紧急车辆)

8. Highway相关场景: 10个 (4.5%)
   - HighwayCutIn (高速切入)
   - HighwayExit (高速出口)

【对应关系分析】

✅ 有明确对应的bucket (匹配良好):
1. leading_object_walker (权重0.05)
   - 对应: PedestrianCrossing, ParkingCrossingPedestrian, CrossingBicycleFlow
   - Benchmark中: 15个场景 (6.8%)
   - 匹配度: ✓ 良好

2. leading_object_vehicle (权重0.09)
   - 对应: 所有车辆交互场景
   - Benchmark中: 60个场景 (27.3%)
   - 匹配度: ✓ 良好

3. vehicle_side (权重0.08)
   - 对应: HazardAtSideLane, VehicleOpensDoorTwoWays
   - Benchmark中: 15个场景 (6.8%)
   - 匹配度: ✓ 良好

4. parkinglane (权重0.008)
   - 对应: ParkingCutIn, ParkingExit, ParkingCrossingPedestrian
   - Benchmark中: 15个场景 (6.8%)
   - 匹配度: ✓ 良好 (但权重偏低)

⚠️ 部分对应的bucket (覆盖不完整):
1. leading_object_traffic.traffic_light (权重0.07)
   - 对应: 有交通灯的junction场景
   - Benchmark中: 50个场景 (22.7%)
   - 问题: 只覆盖了部分有交通灯的场景，缺少无信号灯junction

2. leading_object_traffic.stop (权重0.07)
   - 对应: VanillaNonSignalizedTurnEncounterStopsign
   - Benchmark中: 5个场景 (2.3%)
   - 问题: 覆盖范围较小

3. vehicle_front (权重0.04)
   - 对应: HighwayCutIn, StaticCutIn, MergerIntoSlowTraffic
   - Benchmark中: 20个场景 (9.1%)
   - 问题: 只覆盖了部分前方车辆场景

❌ Benchmark中大量场景但训练配置中缺失:
1. Junction场景 (60个，27.3%)
   - 问题: 训练配置中没有专门的junction bucket
   - 影响: Benchmark中27.3%的场景类型在训练中没有专门覆盖
   - 建议: 增加junction bucket，权重建议0.10-0.15

2. Obstacle场景 (35个，15.9%)
   - 问题: 训练配置中没有专门的obstacle bucket
   - 影响: 停车障碍、施工障碍等场景训练不足
   - 建议: 增加obstacle相关bucket

3. Emergency/Accident场景 (15个，6.8%)
   - 问题: 训练配置中没有专门的emergency bucket
   - 影响: 事故、紧急情况处理能力不足
   - 建议: 增加emergency/accident bucket

4. Control相关场景 (20个，9.1%)
   - 问题: 训练配置中没有专门的control loss bucket
   - 影响: 失控、急刹等场景训练不足
   - 建议: 增加control_loss或hard_brake bucket

⚠️ 训练配置中有但benchmark中不明确的:
1. lateral_control相关 (权重0.24)
   - Benchmark中未明确标注横向控制程度
   - 但所有转弯、变道场景都需要横向控制
   - 可能匹配: 大部分场景都需要横向控制

2. acceleration相关 (权重0.12)
   - Benchmark中未明确标注加速度范围
   - 但HardBreakRoute, ControlLoss等场景需要急加速/急减速
   - 可能匹配: 部分场景需要极端加速度

3. start_from_stop (权重0.07)
   - Benchmark中未明确标注
   - 可能匹配: 所有需要从停止状态启动的场景

【结论与建议】

❌ 主要问题:
1. 训练数据采样策略与benchmark场景特征匹配度不高
2. Benchmark中27.3%的Junction场景在训练配置中没有专门覆盖
3. Benchmark中15.9%的Obstacle场景在训练配置中缺失
4. Benchmark中9.1%的Control相关场景在训练配置中缺失

✅ 建议:
1. 增加junction bucket (权重0.10-0.15)，覆盖所有junction相关场景
2. 增加obstacle bucket，覆盖停车障碍、施工障碍等场景
3. 增加emergency/accident bucket，提高紧急情况处理能力
4. 增加control_loss或hard_brake bucket，提高极端控制场景能力
5. 考虑提高parkinglane权重 (当前0.008偏低，benchmark中有6.8%的场景)
6. 考虑提高leading_object_traffic.traffic_light权重 (benchmark中22.7%的场景涉及交通灯)

【总结】
当前训练配置的bucket分布并没有充分依据benchmark的场景特征进行设计。
Benchmark中大量关键场景类型（Junction、Obstacle、Emergency等）在训练配置中缺失或覆盖不足，
这可能导致模型在benchmark测试时表现不佳。建议根据benchmark的场景分布重新调整bucket配置。

========================================================================================================================
