#!/bin/bash

# é…ç½®ä¿¡æ¯ - è¯·æ›¿æ¢ä»¥ä¸‹placeholder
GITHUB_TOKEN="YOUR_GITHUB_TOKEN_HERE"
AWS_ACCESS_KEY_ID="YOUR_AWS_ACCESS_KEY_ID_HERE"
AWS_SECRET_ACCESS_KEY="YOUR_AWS_SECRET_ACCESS_KEY_HERE"
HUGGINGFACE_TOKEN="YOUR_HUGGINGFACE_TOKEN_HERE"

# setup anaconda ###############################################################################
echo "æ­£åœ¨ä¸‹è½½Anaconda..."
wget https://repo.anaconda.com/archive/Anaconda3-2025.06-0-Linux-x86_64.sh

echo "æ­£åœ¨å®‰è£…Anaconda..."
# ä½¿ç”¨é™é»˜å®‰è£…ï¼Œ-b è¡¨ç¤ºbatch modeï¼Œ-p æŒ‡å®šå®‰è£…è·¯å¾„
bash Anaconda3-2025.06-0-Linux-x86_64.sh -b -p $HOME/anaconda3

echo "æ­£åœ¨åˆå§‹åŒ–conda..."
# é‡æ–°åŠ è½½bashrcä»¥ä½¿condaå¯ç”¨
eval "$($HOME/anaconda3/bin/conda shell.bash hook)"

echo "éªŒè¯condaå®‰è£…..."
conda --version


# setup github ###############################################################################
echo "æ­£åœ¨å®‰è£…GitHub CLI..."
# æ ¹æ®ç³»ç»Ÿå®‰è£…GitHub CLI
if command -v apt-get &> /dev/null; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt update
    sudo apt install gh -y
elif command -v yum &> /dev/null; then
    sudo dnf install 'dnf-command(config-manager)'
    sudo dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
    sudo dnf install gh -y
fi

echo "æ­£åœ¨è®¾ç½®SSHå¯†é’¥..."
# ç¡®ä¿.sshç›®å½•å­˜åœ¨
mkdir -p ~/.ssh
cd ~/.ssh

# ç”ŸæˆSSHå¯†é’¥ï¼Œä½¿ç”¨æ­£ç¡®çš„è¯­æ³•é¿å…echoå‚æ•°é—®é¢˜
ssh-keygen -t rsa -C 'mh2803_qwenvl@rit.edu' -f ~/.ssh/id_rsa -N ""

echo "æ­£åœ¨å¯åŠ¨ssh-agentå¹¶æ·»åŠ å¯†é’¥..."
# å¯åŠ¨ssh-agentå¹¶æ·»åŠ å¯†é’¥
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa

echo "æ­£åœ¨ä½¿ç”¨GitHub CLIç™»å½•..."
# ä½¿ç”¨GitHub CLIç™»å½•
echo "$GITHUB_TOKEN" | gh auth login --with-token

echo "æ­£åœ¨æ·»åŠ SSHå¯†é’¥åˆ°GitHub..."
# æ·»åŠ SSHå¯†é’¥åˆ°GitHub
gh ssh-key add ~/.ssh/id_rsa.pub --title "setup-script-key"

echo "æ­£åœ¨æµ‹è¯•GitHubè¿æ¥..."
# æµ‹è¯•GitHubè¿æ¥ï¼Œè‡ªåŠ¨æ¥å—host key
ssh-keyscan -H github.com >> ~/.ssh/known_hosts
ssh -T git@github.com

# setup repo ###############################################################################
echo "æ­£åœ¨å…‹éš†ä»“åº“..."
# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p /code
cd /code

# æ£€æŸ¥ä»“åº“æ˜¯å¦å·²å­˜åœ¨
if [ -d "/code/doc_sign_search/.git" ]; then
    echo "ä»“åº“å·²å­˜åœ¨äº /code/doc_sign_search"
    cd /code/doc_sign_search
    echo "æ­£åœ¨æ›´æ–°ä»“åº“..."
    git pull || echo "æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
else
    echo "æ­£åœ¨ä» git@github.com:meibohuhu/doc_sign_search.git å…‹éš†ä»“åº“..."
    git clone git@github.com:meibohuhu/doc_sign_search.git
    cd /code/doc_sign_search
fi

# setup qwenvl conda environment ###############################################################################
echo "æ¥å— ToS..."
$HOME/anaconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
$HOME/anaconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

echo "æ­£åœ¨åˆ›å»ºqwenvlç¯å¢ƒ..."
# æ£€æŸ¥ç¯å¢ƒæ˜¯å¦å·²å­˜åœ¨
if conda env list | grep -q "^qwenvl "; then
    echo "ç¯å¢ƒ qwenvl å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
else
    echo "æ­£åœ¨åˆ›å»ºæ–°ç¯å¢ƒ qwenvl..."
    $HOME/anaconda3/bin/conda create -n qwenvl python=3.10 -y
fi

echo "æ­£åœ¨è¿›å…¥é¡¹ç›®ç›®å½•..."
cd /code/doc_sign_search

echo "æ­£åœ¨æ¿€æ´»qwenvlç¯å¢ƒå¹¶å®‰è£…åŒ…..."
# æ¿€æ´»ç¯å¢ƒå¹¶å®‰è£…åŒ…
conda activate qwenvl

############ å®‰è£…åŒ…
echo "æ­£åœ¨å®‰è£…æ„å»ºä¾èµ–ï¼ˆpsutil, packaging, ninjaï¼‰..."
pip install psutil packaging ninja

echo "æ­£åœ¨å®‰è£…PyTorch with CUDA 12.1..."
pip install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 --index-url https://download.pytorch.org/whl/cu121

echo "æ­£åœ¨å®‰è£…flash-attn..."
if pip install flash-attn==2.5.7 --no-build-isolation; then
    echo "âœ… flash-attn å®‰è£…æˆåŠŸ"
else
    echo "âš ï¸  ç¬¬ä¸€æ¬¡å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ --no-deps é€‰é¡¹..."
    pip install flash-attn==2.5.7 --no-build-isolation --no-deps || echo "âš ï¸  flash-attn å®‰è£…å¤±è´¥ï¼Œä½†å¯ä»¥ç»§ç»­ï¼ˆæŸäº›åŠŸèƒ½å¯èƒ½è¾ƒæ…¢ï¼‰"
fi

echo "æ­£åœ¨ä½¿ç”¨requirements_qwenvl.txtå®‰è£…å…¶ä»–ä¾èµ–..."
pip install -r /code/doc_sign_search/requirements_qwenvl.txt

pip cache purge


# setup huggingface ###############################################################################
echo "æ­£åœ¨ç™»å½•Huggingface..."
# ä½¿ç”¨æ­£ç¡®çš„ç™»å½•æ–¹å¼
huggingface-cli login --token "$HUGGINGFACE_TOKEN"

# download and extract videos ###############################################################################
echo "æ­£åœ¨ä¸‹è½½å’Œè§£å‹è§†é¢‘..."
DOWNLOAD_SCRIPT="/code/doc_sign_search/download_and_extract_videos_from_hf.py"
VIDEO_DATASET_NAME="${VIDEO_DATASET_NAME:-PhoenixHu/sign_mllm_openasl_videos}"
VIDEO_OUTPUT_DIR="${VIDEO_OUTPUT_DIR:-/mnt/localssd/sign_mllm_openasl_videos}"
FORCE_DOWNLOAD_VIDEOS="${FORCE_DOWNLOAD_VIDEOS:-0}"

# æ£€æŸ¥ä¸‹è½½è„šæœ¬æ˜¯å¦å­˜åœ¨
if [ ! -f "$DOWNLOAD_SCRIPT" ]; then
    echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°ä¸‹è½½è„šæœ¬ $DOWNLOAD_SCRIPT"
    echo "   è·³è¿‡è§†é¢‘ä¸‹è½½æ­¥éª¤"
else
    # æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²å­˜åœ¨
    if [ -d "$VIDEO_OUTPUT_DIR" ] && [ "$(ls -A $VIDEO_OUTPUT_DIR 2>/dev/null)" ]; then
        echo "ğŸ“ è§†é¢‘ç›®å½•å·²å­˜åœ¨ä¸”ä¸ä¸ºç©º: $VIDEO_OUTPUT_DIR"
        echo "   è·³è¿‡ä¸‹è½½æ­¥éª¤ï¼ˆå¦‚éœ€é‡æ–°ä¸‹è½½ï¼Œè¯·åˆ é™¤è¯¥ç›®å½•æˆ–è®¾ç½® FORCE_DOWNLOAD_VIDEOS=1ï¼‰"
        
        # å¦‚æœè®¾ç½®äº†å¼ºåˆ¶ä¸‹è½½ï¼Œåˆ™ç»§ç»­ä¸‹è½½
        if [ "${FORCE_DOWNLOAD_VIDEOS:-0}" != "1" ]; then
            echo "âœ… ä½¿ç”¨ç°æœ‰è§†é¢‘æ–‡ä»¶"
        else
            echo "ğŸ”„ å¼ºåˆ¶ä¸‹è½½æ¨¡å¼ï¼šå°†é‡æ–°ä¸‹è½½è§†é¢‘"
            python "$DOWNLOAD_SCRIPT" \
                --dataset_name "$VIDEO_DATASET_NAME" \
                --output_dir "$VIDEO_OUTPUT_DIR" \
                --token "$HUGGINGFACE_TOKEN" \
                --remove_archives
        fi
    else
        echo "ğŸ“¥ å¼€å§‹ä¸‹è½½è§†é¢‘æ•°æ®é›†: $VIDEO_DATASET_NAME"
        echo "ğŸ“ è¾“å‡ºç›®å½•: $VIDEO_OUTPUT_DIR"
        
        # è¿è¡Œä¸‹è½½è„šæœ¬ï¼ˆä½¿ç”¨condaç¯å¢ƒä¸­çš„pythonï¼‰
        python "$DOWNLOAD_SCRIPT" \
            --dataset_name "$VIDEO_DATASET_NAME" \
            --output_dir "$VIDEO_OUTPUT_DIR" \
            --token "$HUGGINGFACE_TOKEN" \
            --remove_archives
        
        if [ $? -eq 0 ]; then
            echo "âœ… è§†é¢‘ä¸‹è½½å’Œè§£å‹å®Œæˆï¼"
            echo "ğŸ“ è§†é¢‘ä½ç½®: $VIDEO_OUTPUT_DIR"
        else
            echo "âš ï¸  è­¦å‘Š: è§†é¢‘ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæ•°æ®é›†åç§°"
        fi
    fi
fi


# è®¾ç½®ç¯å¢ƒå˜é‡
echo "æ­£åœ¨è®¾ç½®ç¯å¢ƒå˜é‡..."
export PYTHONPATH="/code/sign_language_llm:${PYTHONPATH:-}"
export TOKENIZERS_PARALLELISM=false
export OMP_NUM_THREADS=8

# æ·»åŠ åˆ°bashrcä»¥ä¾¿æ°¸ä¹…ç”Ÿæ•ˆ
if ! grep -q "export PYTHONPATH.*/code/sign_language_llm" ~/.bashrc 2>/dev/null; then
    echo "" >> ~/.bashrc
    echo "# QwenVL environment" >> ~/.bashrc
    echo "export PYTHONPATH=\"/code/sign_language_llm:\${PYTHONPATH:-}\"" >> ~/.bashrc
    echo "export TOKENIZERS_PARALLELISM=false" >> ~/.bashrc
fi

echo "è®¾ç½®å®Œæˆï¼"

# enable conda env  ############################################################################### 

# æ°¸ä¹…åˆå§‹åŒ–condaå¹¶æ¿€æ´»baseç¯å¢ƒ
echo "æ­£åœ¨æ°¸ä¹…å¯ç”¨conda..."
$HOME/anaconda3/bin/conda init bash
exec bash
